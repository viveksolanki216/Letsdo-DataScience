<html>
	<head>
		<title> The first Bubble Graph</title>
	</head>
	
	<body>

		<h1>My First Graph</h1>
		<script src= "./d3.v3.min.js"></script>
		<style>
		#chart {
			margin-left: -40px;
			height: 600px;
			width: 900px;
		}
		text {
			font: 10 px sans-serif;
		}
		.dot{
			stroke: #000;
		}
		.axis path .axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}
		.label{
			fill: #777;
		}
		.year.label{
			font: 500 196px "Helvetica Neue";
		}
		.year.label.active {
	 		 fill: #aaa;
		}
		.overlay {
			  fill: none;
			  pointer-events: all;
			  cursor: ew-resize;
		}
		</style>
		<div id="chart"></div>
		<script>
		var margin = {top:20, left:70, right:20, bottom:40};
		var width = 800-margin.right-margin.left;
		var height = 500-margin.top-margin.bottom;
		var maxBubbleRad = 40;

		var x_scale = d3.scale.sqrt().domain([1,7e7]).range([0,width]);
		var y_scale = d3.scale.sqrt().domain([1,15e4]).range([height,0]);
		var rad_scale = d3.scale.sqrt().domain([1,2e7]).range([0,maxBubbleRad]);
		// category10 is for 10 colors for categorical variable
		var color_scale = d3.scale.category10();
		// create x and y axis for chart
		var x_axis = d3.svg.axis().orient("bottom").scale(x_scale).ticks(12, d3.format(",d"));
		var y_axis = d3.svg.axis().orient("left").scale(y_scale);

		var svg = d3.select("#chart") // select the tag which has id char
					.append("svg") // create a append child node inside the tag
					.attr("width",width+margin.left+margin.right) 
					.attr("height",height+margin.top+margin.bottom)  // set height and widht for svg tag
					.append("g") // append a g tag
					.attr("transform","translate("+margin.left+","+margin.top+")") // put the g tag in the top-left corner
		svg.append("g")
			.attr("class","x_axis")
			.attr("transform","translate(0,"+height+")")
			.call(x_axis); //add x axis in chart

		svg.append("g")
			.attr("class","y_axis")
			//.attr("transform","translate(0,0)")
			.call(y_axis); //add x axis in chart

		// add label for x axis
		// add label for y axis

		//add a label for year, where on hovering above it you can change the year
		var label = svg.append("text")
	    .attr("class", "year label")
	    .attr("text-anchor", "end")
	    .attr("y", height - 24)
	    .attr("x", width)
	    .text(1);	
	    var box = label.node().getBBox();

	   

		function x(d) { return d.gross_bookings;}
		function y(d) { return d.number_of_deals;}
		function radius(d) { return d.gross_revenue;}
		function color(d) {  return d.economic_region;}
		function key(d) { return d.country_name;}
		
		d3.json("temp.json", function( error, data) {
			

		    var bisect = d3.bisector(function(d) { return d[0]; });

			// put the bubbles for the starting year
			var dot = svg.append("g")
				.attr("class","dots")
				.selectAll(".dot")
				.data(interpolateData(1))
				.enter().append("circle")
				.attr("class","dot")
				.style("fill",function(d) { return color_scale(color(d));})
				.call(position)
				.sort(order)
			// append the title for each bubble
			dot.append("title")
				.text(function(d) {return key(d);})
 			// overlay a rectangel which will make the mouce hover over it
 			var overlay = svg.append("rect")
	        .attr("class", "overlay")
	        .attr("x", box.x)
	        .attr("y", box.y)
	        .attr("width", box.width)
	        .attr("height", box.height)
	        .on("mouseover", enableInteraction);
			

			// start a transition for different years
			svg.transition()
		      .duration(30000)
		      .ease("linear")
		      .tween("year",tweenYear)  // it will provide  values from 0-1 which will be given to year line:126
			 .each("end", enableInteraction);

		     function tweenYear(){
		     	var year = d3.interpolateNumber(1,75); // this function 'year' will take vlaues from 0-1 and produces all possible years from 2012-2015 (in fractions also)
		     	return function(t) { displayYear(year(t));};
		     }
		     function displayYear(year){
		     	dot.data(interpolateData(year),key)
		     	.call(position)
		     	.sort(order);
		     	label.text(Math.round(year));

		     }
		     function interpolateData(year) {
		     	return data.map( function(d) {
		     		return {
		     			country_name: d.country_name,
		     			economic_region: d.economic_region,
		     			gross_bookings: interpolateValues(d.gross_bookings, year),
				        gross_revenue: interpolateValues(d.gross_revenue, year),
				        number_of_deals: interpolateValues(d.number_of_deals, year)
		     		};
		     	});
		     }
	 		function position(dot) {
				dot.attr("cx",function(d) { return x_scale(x(d));})
					.attr("cy",function(d) { return y_scale(y(d));})
					.attr("r",function(d) { return rad_scale(radius(d));})
			}
			function order( a, b){
				return radius(b) - radius(a);
			}
			
			function interpolateValues(values, year) {
			    var i = bisect.left(values, year, 0, values.length - 1),
			        a = values[i];
			    if (i > 0) {
			      var b = values[i - 1],
			          t = (year - a[0]) / (b[0] - a[0]);
			      return a[1] * (1 - t) + b[1] * t;
			    }
			    return a[1];
			  }
			function enableInteraction() {
			    var yearScale = d3.scale.linear()
			        .domain([1, 75])
			        .range([box.x + 10, box.x + box.width - 10])
			        .clamp(true);

			    // Cancel the current transition, if any.
			    svg.transition().duration(0);

			    overlay
			        .on("mouseover", mouseover)
			        .on("mouseout", mouseout)
			        .on("mousemove", mousemove)
			        .on("touchmove", mousemove);

			    function mouseover() {
			      label.classed("active", true);
			    }

			    function mouseout() {
			      label.classed("active", false);
			    }

			    function mousemove() {
			      displayYear(yearScale.invert(d3.mouse(this)[0]));
			    }
			  }
		});
		</script>

	
	</body>
</html>